
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>marshmallow_dataclass &#8212; marshmallow_dataclass 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for marshmallow_dataclass</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This library allows the conversion of python 3.7&#39;s :mod:`dataclasses`</span>
<span class="sd">to :mod:`marshmallow` schemas.</span>

<span class="sd">It takes a python class, and generates a marshmallow schema for it.</span>

<span class="sd">Simple example::</span>

<span class="sd">    from marshmallow import Schema</span>
<span class="sd">    from marshmallow_dataclass import dataclass</span>

<span class="sd">    @dataclass</span>
<span class="sd">    class Point:</span>
<span class="sd">      x:float</span>
<span class="sd">      y:float</span>

<span class="sd">    point = Point(x=0, y=0)</span>
<span class="sd">    point_json = Point.Schema().dumps(point)</span>

<span class="sd">Full example::</span>

<span class="sd">    from marshmallow import Schema</span>
<span class="sd">    from dataclasses import field</span>
<span class="sd">    from marshmallow_dataclass import dataclass</span>
<span class="sd">    import datetime</span>

<span class="sd">    @dataclass</span>
<span class="sd">    class User:</span>
<span class="sd">      birth: datetime.date = field(metadata= {</span>
<span class="sd">        &quot;required&quot;: True # A parameter to pass to marshmallow&#39;s field</span>
<span class="sd">      })</span>
<span class="sd">      website:str = field(metadata = {</span>
<span class="sd">        &quot;marshmallow_field&quot;: marshmallow.fields.Url() # Custom marshmallow field</span>
<span class="sd">      })</span>
<span class="sd">      Schema: ClassVar[Type[Schema]] = Schema # For the type checker</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">collections.abc</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">EnumMeta</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span><span class="p">,</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">NewType</span> <span class="k">as</span> <span class="n">typing_NewType</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
    <span class="n">get_type_hints</span><span class="p">,</span>
    <span class="n">overload</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">FrozenSet</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">marshmallow</span>
<span class="kn">import</span> <span class="nn">typing_inspect</span>

<span class="kn">from</span> <span class="nn">marshmallow_dataclass.lazy_class_attribute</span> <span class="kn">import</span> <span class="n">lazy_class_attribute</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dataclass&quot;</span><span class="p">,</span> <span class="s2">&quot;add_schema&quot;</span><span class="p">,</span> <span class="s2">&quot;class_schema&quot;</span><span class="p">,</span> <span class="s2">&quot;field_for_schema&quot;</span><span class="p">,</span> <span class="s2">&quot;NewType&quot;</span><span class="p">]</span>

<span class="n">NoneType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">_U</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_U&quot;</span><span class="p">)</span>

<span class="c1"># Whitelist of dataclass members that will be copied to generated schema.</span>
<span class="n">MEMBERS_WHITELIST</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Meta&quot;</span><span class="p">}</span>

<span class="c1"># Max number of generated schemas that class_schema keeps of generated schemas. Removes duplicates.</span>
<span class="n">MAX_CLASS_SCHEMA_CACHE_SIZE</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="c1"># Recursion guard for class_schema()</span>
<span class="n">_RECURSION_GUARD</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>


<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">dataclass</span><span class="p">(</span>
    <span class="n">_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="nb">repr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">eq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">order</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">unsafe_hash</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">frozen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">base_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cls_frame</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">FrameType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">dataclass</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="nb">repr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">eq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">order</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">unsafe_hash</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">frozen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">base_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cls_frame</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">FrameType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">]],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">]]:</span>
    <span class="o">...</span>


<span class="c1"># _cls should never be specified by keyword, so start it with an</span>
<span class="c1"># underscore.  The presence of _cls is used to detect if this</span>
<span class="c1"># decorator is being called with parameters or not.</span>
<div class="viewcode-block" id="dataclass"><a class="viewcode-back" href="../stubs/marshmallow_dataclass.dataclass.html#marshmallow_dataclass.dataclass">[docs]</a><span class="k">def</span> <span class="nf">dataclass</span><span class="p">(</span>
    <span class="n">_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="nb">repr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">eq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">order</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">unsafe_hash</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">frozen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">base_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cls_frame</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">FrameType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">],</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">]],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">]]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This decorator does the same as dataclasses.dataclass, but also applies :func:`add_schema`.</span>
<span class="sd">    It adds a `.Schema` attribute to the class object</span>

<span class="sd">    :param base_schema: marshmallow schema used as a base class when deriving dataclass schema</span>
<span class="sd">    :param cls_frame: frame of cls definition, used to obtain locals with other classes definitions.</span>
<span class="sd">        If None is passed the caller frame will be treated as cls_frame</span>

<span class="sd">    &gt;&gt;&gt; @dataclass</span>
<span class="sd">    ... class Artist:</span>
<span class="sd">    ...    name: str</span>
<span class="sd">    &gt;&gt;&gt; Artist.Schema</span>
<span class="sd">    &lt;class &#39;marshmallow.schema.Artist&#39;&gt;</span>

<span class="sd">    &gt;&gt;&gt; from typing import ClassVar</span>
<span class="sd">    &gt;&gt;&gt; from marshmallow import Schema</span>
<span class="sd">    &gt;&gt;&gt; @dataclass(order=True) # preserve field order</span>
<span class="sd">    ... class Point:</span>
<span class="sd">    ...   x:float</span>
<span class="sd">    ...   y:float</span>
<span class="sd">    ...   Schema: ClassVar[Type[Schema]] = Schema # For the type checker</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt; Point.Schema().load({&#39;x&#39;:0, &#39;y&#39;:0}) # This line can be statically type checked</span>
<span class="sd">    Point(x=0.0, y=0.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># dataclass&#39;s typing doesn&#39;t expect it to be called as a function, so ignore type check</span>
    <span class="n">dc</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="n">_cls</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="nb">repr</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="n">eq</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">unsafe_hash</span><span class="o">=</span><span class="n">unsafe_hash</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="n">frozen</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cls_frame</span><span class="p">:</span>
        <span class="n">current_frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">current_frame</span><span class="p">:</span>
            <span class="n">cls_frame</span> <span class="o">=</span> <span class="n">current_frame</span><span class="o">.</span><span class="n">f_back</span>
        <span class="c1"># Per https://docs.python.org/3/library/inspect.html#the-interpreter-stack</span>
        <span class="k">del</span> <span class="n">current_frame</span>
    <span class="k">if</span> <span class="n">_cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">add_schema</span><span class="p">(</span><span class="n">dc</span><span class="p">(</span><span class="bp">cls</span><span class="p">),</span> <span class="n">base_schema</span><span class="p">,</span> <span class="n">cls_frame</span><span class="o">=</span><span class="n">cls_frame</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">add_schema</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">base_schema</span><span class="p">,</span> <span class="n">cls_frame</span><span class="o">=</span><span class="n">cls_frame</span><span class="p">)</span></div>


<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">add_schema</span><span class="p">(</span><span class="n">_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">add_schema</span><span class="p">(</span>
    <span class="n">base_schema</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">]],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">]]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">add_schema</span><span class="p">(</span>
    <span class="n">_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">],</span>
    <span class="n">base_schema</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cls_frame</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">FrameType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">]:</span>
    <span class="o">...</span>


<div class="viewcode-block" id="add_schema"><a class="viewcode-back" href="../marshmallow_dataclass.html#marshmallow_dataclass.add_schema">[docs]</a><span class="k">def</span> <span class="nf">add_schema</span><span class="p">(</span><span class="n">_cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cls_frame</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This decorator adds a marshmallow schema as the &#39;Schema&#39; attribute in a dataclass.</span>
<span class="sd">    It uses :func:`class_schema` internally.</span>

<span class="sd">    :param type _cls: The dataclass to which a Schema should be added</span>
<span class="sd">    :param base_schema: marshmallow schema used as a base class when deriving dataclass schema</span>
<span class="sd">    :param cls_frame: frame of cls definition</span>

<span class="sd">    &gt;&gt;&gt; class BaseSchema(marshmallow.Schema):</span>
<span class="sd">    ...   def on_bind_field(self, field_name, field_obj):</span>
<span class="sd">    ...     field_obj.data_key = (field_obj.data_key or field_name).upper()</span>

<span class="sd">    &gt;&gt;&gt; @add_schema(base_schema=BaseSchema)</span>
<span class="sd">    ... @dataclasses.dataclass</span>
<span class="sd">    ... class Artist:</span>
<span class="sd">    ...    names: Tuple[str, str]</span>
<span class="sd">    &gt;&gt;&gt; artist = Artist.Schema().loads(&#39;{&quot;NAMES&quot;: [&quot;Martin&quot;, &quot;Ramirez&quot;]}&#39;)</span>
<span class="sd">    &gt;&gt;&gt; artist</span>
<span class="sd">    Artist(names=(&#39;Martin&#39;, &#39;Ramirez&#39;))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">clazz</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">]:</span>
        <span class="c1"># noinspection PyTypeHints</span>
        <span class="n">clazz</span><span class="o">.</span><span class="n">Schema</span> <span class="o">=</span> <span class="n">lazy_class_attribute</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">partial</span><span class="p">(</span><span class="n">class_schema</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">base_schema</span><span class="p">,</span> <span class="n">cls_frame</span><span class="p">),</span>
            <span class="s2">&quot;Schema&quot;</span><span class="p">,</span>
            <span class="n">clazz</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">clazz</span>

    <span class="k">return</span> <span class="n">decorator</span><span class="p">(</span><span class="n">_cls</span><span class="p">)</span> <span class="k">if</span> <span class="n">_cls</span> <span class="k">else</span> <span class="n">decorator</span></div>


<div class="viewcode-block" id="class_schema"><a class="viewcode-back" href="../stubs/marshmallow_dataclass.class_schema.html#marshmallow_dataclass.class_schema">[docs]</a><span class="k">def</span> <span class="nf">class_schema</span><span class="p">(</span>
    <span class="n">clazz</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
    <span class="n">base_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">clazz_frame</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">FrameType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a class to a marshmallow schema</span>

<span class="sd">    :param clazz: A python class (may be a dataclass)</span>
<span class="sd">    :param base_schema: marshmallow schema used as a base class when deriving dataclass schema</span>
<span class="sd">    :param clazz_frame: frame of cls definition</span>
<span class="sd">    :return: A marshmallow Schema corresponding to the dataclass</span>

<span class="sd">    .. note::</span>
<span class="sd">        All the arguments supported by marshmallow field classes can</span>
<span class="sd">        be passed in the `metadata` dictionary of a field.</span>


<span class="sd">    If you want to use a custom marshmallow field</span>
<span class="sd">    (one that has no equivalent python type), you can pass it as the</span>
<span class="sd">    ``marshmallow_field`` key in the metadata dictionary.</span>

<span class="sd">    &gt;&gt;&gt; import typing</span>
<span class="sd">    &gt;&gt;&gt; Meters = typing.NewType(&#39;Meters&#39;, float)</span>
<span class="sd">    &gt;&gt;&gt; @dataclasses.dataclass()</span>
<span class="sd">    ... class Building:</span>
<span class="sd">    ...   height: Optional[Meters]</span>
<span class="sd">    ...   name: str = dataclasses.field(default=&quot;anonymous&quot;)</span>
<span class="sd">    ...   class Meta:</span>
<span class="sd">    ...     ordered = True</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt; class_schema(Building) # Returns a marshmallow schema class (not an instance)</span>
<span class="sd">    &lt;class &#39;marshmallow.schema.Building&#39;&gt;</span>
<span class="sd">    &gt;&gt;&gt; @dataclasses.dataclass()</span>
<span class="sd">    ... class City:</span>
<span class="sd">    ...   name: str = dataclasses.field(metadata={&#39;required&#39;:True})</span>
<span class="sd">    ...   best_building: Building # Reference to another dataclass. A schema will be created for it too.</span>
<span class="sd">    ...   other_buildings: List[Building] = dataclasses.field(default_factory=lambda: [])</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt; citySchema = class_schema(City)()</span>
<span class="sd">    &gt;&gt;&gt; city = citySchema.load({&quot;name&quot;:&quot;Paris&quot;, &quot;best_building&quot;: {&quot;name&quot;: &quot;Eiffel Tower&quot;}})</span>
<span class="sd">    &gt;&gt;&gt; city</span>
<span class="sd">    City(name=&#39;Paris&#39;, best_building=Building(height=None, name=&#39;Eiffel Tower&#39;), other_buildings=[])</span>

<span class="sd">    &gt;&gt;&gt; citySchema.load({&quot;name&quot;:&quot;Paris&quot;})</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    marshmallow.exceptions.ValidationError: {&#39;best_building&#39;: [&#39;Missing data for required field.&#39;]}</span>

<span class="sd">    &gt;&gt;&gt; city_json = citySchema.dump(city)</span>
<span class="sd">    &gt;&gt;&gt; city_json[&#39;best_building&#39;] # We get an OrderedDict because we specified order = True in the Meta class</span>
<span class="sd">    OrderedDict([(&#39;height&#39;, None), (&#39;name&#39;, &#39;Eiffel Tower&#39;)])</span>

<span class="sd">    &gt;&gt;&gt; @dataclasses.dataclass()</span>
<span class="sd">    ... class Person:</span>
<span class="sd">    ...   name: str = dataclasses.field(default=&quot;Anonymous&quot;)</span>
<span class="sd">    ...   friends: List[&#39;Person&#39;] = dataclasses.field(default_factory=lambda:[]) # Recursive field</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt; person = class_schema(Person)().load({</span>
<span class="sd">    ...     &quot;friends&quot;: [{&quot;name&quot;: &quot;Roger Boucher&quot;}]</span>
<span class="sd">    ... })</span>
<span class="sd">    &gt;&gt;&gt; person</span>
<span class="sd">    Person(name=&#39;Anonymous&#39;, friends=[Person(name=&#39;Roger Boucher&#39;, friends=[])])</span>

<span class="sd">    &gt;&gt;&gt; @dataclasses.dataclass()</span>
<span class="sd">    ... class C:</span>
<span class="sd">    ...   important: int = dataclasses.field(init=True, default=0)</span>
<span class="sd">    ...    # Only fields that are in the __init__ method will be added:</span>
<span class="sd">    ...   unimportant: int = dataclasses.field(init=False, default=0)</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt; c = class_schema(C)().load({</span>
<span class="sd">    ...     &quot;important&quot;: 9, # This field will be imported</span>
<span class="sd">    ...     &quot;unimportant&quot;: 9 # This field will NOT be imported</span>
<span class="sd">    ... }, unknown=marshmallow.EXCLUDE)</span>
<span class="sd">    &gt;&gt;&gt; c</span>
<span class="sd">    C(important=9, unimportant=0)</span>

<span class="sd">    &gt;&gt;&gt; @dataclasses.dataclass</span>
<span class="sd">    ... class Website:</span>
<span class="sd">    ...  url:str = dataclasses.field(metadata = {</span>
<span class="sd">    ...    &quot;marshmallow_field&quot;: marshmallow.fields.Url() # Custom marshmallow field</span>
<span class="sd">    ...  })</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt; class_schema(Website)().load({&quot;url&quot;: &quot;I am not a good URL !&quot;})</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    marshmallow.exceptions.ValidationError: {&#39;url&#39;: [&#39;Not a valid URL.&#39;]}</span>

<span class="sd">    &gt;&gt;&gt; @dataclasses.dataclass</span>
<span class="sd">    ... class NeverValid:</span>
<span class="sd">    ...     @marshmallow.validates_schema</span>
<span class="sd">    ...     def validate(self, data, **_):</span>
<span class="sd">    ...         raise marshmallow.ValidationError(&#39;never valid&#39;)</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt; class_schema(NeverValid)().load({})</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    marshmallow.exceptions.ValidationError: {&#39;_schema&#39;: [&#39;never valid&#39;]}</span>

<span class="sd">    &gt;&gt;&gt; @dataclasses.dataclass</span>
<span class="sd">    ... class Anything:</span>
<span class="sd">    ...     name: str</span>
<span class="sd">    ...     @marshmallow.validates(&#39;name&#39;)</span>
<span class="sd">    ...     def validates(self, value):</span>
<span class="sd">    ...         if len(value) &gt; 5: raise marshmallow.ValidationError(&quot;Name too long&quot;)</span>
<span class="sd">    &gt;&gt;&gt; class_schema(Anything)().load({&quot;name&quot;: &quot;aaaaaargh&quot;})</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    marshmallow.exceptions.ValidationError: {&#39;name&#39;: [&#39;Name too long&#39;]}</span>

<span class="sd">    You can use the ``metadata`` argument to override default field behaviour, e.g. the fact that</span>
<span class="sd">    ``Optional`` fields allow ``None`` values:</span>

<span class="sd">    &gt;&gt;&gt; @dataclasses.dataclass</span>
<span class="sd">    ... class Custom:</span>
<span class="sd">    ...     name: Optional[str] = dataclasses.field(metadata={&quot;allow_none&quot;: False})</span>
<span class="sd">    &gt;&gt;&gt; class_schema(Custom)().load({&quot;name&quot;: None})</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    marshmallow.exceptions.ValidationError: {&#39;name&#39;: [&#39;Field may not be null.&#39;]}</span>
<span class="sd">    &gt;&gt;&gt; class_schema(Custom)().load({})</span>
<span class="sd">    Custom(name=None)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">clazz</span><span class="p">):</span>
        <span class="n">clazz</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">clazz</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">clazz_frame</span><span class="p">:</span>
        <span class="n">current_frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">current_frame</span><span class="p">:</span>
            <span class="n">clazz_frame</span> <span class="o">=</span> <span class="n">current_frame</span><span class="o">.</span><span class="n">f_back</span>
        <span class="c1"># Per https://docs.python.org/3/library/inspect.html#the-interpreter-stack</span>
        <span class="k">del</span> <span class="n">current_frame</span>
    <span class="n">_RECURSION_GUARD</span><span class="o">.</span><span class="n">seen_classes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_internal_class_schema</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="n">base_schema</span><span class="p">,</span> <span class="n">clazz_frame</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_RECURSION_GUARD</span><span class="o">.</span><span class="n">seen_classes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">MAX_CLASS_SCHEMA_CACHE_SIZE</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_internal_class_schema</span><span class="p">(</span>
    <span class="n">clazz</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
    <span class="n">base_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">clazz_frame</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">FrameType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">]:</span>
    <span class="n">_RECURSION_GUARD</span><span class="o">.</span><span class="n">seen_classes</span><span class="p">[</span><span class="n">clazz</span><span class="p">]</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># noinspection PyDataclass</span>
        <span class="n">fields</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">dataclasses</span><span class="o">.</span><span class="n">Field</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="n">clazz</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>  <span class="c1"># Not a dataclass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;****** WARNING ****** &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;marshmallow_dataclass was called on the class </span><span class="si">{</span><span class="n">clazz</span><span class="si">}</span><span class="s2">, which is not a dataclass. &quot;</span>
                <span class="s2">&quot;It is going to try and convert the class into a dataclass, which may have &quot;</span>
                <span class="s2">&quot;undesirable side effects. To avoid this message, make sure all your classes and &quot;</span>
                <span class="s2">&quot;all the classes of their fields are either explicitly supported by &quot;</span>
                <span class="s2">&quot;marshmallow_dataclass, or define the schema explicitly using &quot;</span>
                <span class="s2">&quot;field(metadata=dict(marshmallow_field=...)). For more information, see &quot;</span>
                <span class="s2">&quot;https://github.com/lovasoa/marshmallow_dataclass/issues/51 &quot;</span>
                <span class="s2">&quot;****** WARNING ******&quot;</span>
            <span class="p">)</span>
            <span class="n">created_dataclass</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">clazz</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_internal_class_schema</span><span class="p">(</span><span class="n">created_dataclass</span><span class="p">,</span> <span class="n">base_schema</span><span class="p">,</span> <span class="n">clazz_frame</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">clazz</span><span class="p">))</span><span class="si">}</span><span class="s2"> is not a dataclass and cannot be turned into one.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

    <span class="c1"># Copy all marshmallow hooks and whitelisted members of the dataclass to the schema.</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">clazz</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;__marshmallow_hook__&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">MEMBERS_WHITELIST</span>
    <span class="p">}</span>

    <span class="c1"># Update the schema members to contain marshmallow fields instead of dataclass fields</span>
    <span class="n">type_hints</span> <span class="o">=</span> <span class="n">get_type_hints</span><span class="p">(</span>
        <span class="n">clazz</span><span class="p">,</span> <span class="n">localns</span><span class="o">=</span><span class="n">clazz_frame</span><span class="o">.</span><span class="n">f_locals</span> <span class="k">if</span> <span class="n">clazz_frame</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>
    <span class="n">attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">field_for_schema</span><span class="p">(</span>
                <span class="n">type_hints</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                <span class="n">_get_field_default</span><span class="p">(</span><span class="n">field</span><span class="p">),</span>
                <span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">base_schema</span><span class="p">,</span>
                <span class="n">clazz_frame</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">init</span>
    <span class="p">)</span>

    <span class="n">schema_class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">clazz</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">(</span><span class="n">_base_schema</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="n">base_schema</span><span class="p">),),</span> <span class="n">attributes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">],</span> <span class="n">schema_class</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_field_by_type</span><span class="p">(</span>
    <span class="n">typ</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">base_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Field</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">base_schema</span> <span class="ow">and</span> <span class="n">base_schema</span><span class="o">.</span><span class="n">TYPE_MAPPING</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
    <span class="p">)</span> <span class="ow">or</span> <span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">TYPE_MAPPING</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_field_by_supertype</span><span class="p">(</span>
    <span class="n">typ</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span>
    <span class="n">default</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">newtype_supertype</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">base_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">]],</span>
    <span class="n">typ_frame</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">FrameType</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">marshmallow</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Field</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a new field for fields based on a super field. (Usually spawned from NewType)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add the information coming our custom NewType implementation</span>

    <span class="n">typ_args</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s2">&quot;_marshmallow_args&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># Handle multiple validators from both `typ` and `metadata`.</span>
    <span class="c1"># See https://github.com/lovasoa/marshmallow_dataclass/issues/91</span>
    <span class="n">new_validators</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">meta_dict</span> <span class="ow">in</span> <span class="p">(</span><span class="n">typ_args</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;validate&quot;</span> <span class="ow">in</span> <span class="n">meta_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">marshmallow</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">is_iterable_but_not_string</span><span class="p">(</span><span class="n">meta_dict</span><span class="p">[</span><span class="s2">&quot;validate&quot;</span><span class="p">]):</span>
                <span class="n">new_validators</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">meta_dict</span><span class="p">[</span><span class="s2">&quot;validate&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">meta_dict</span><span class="p">[</span><span class="s2">&quot;validate&quot;</span><span class="p">]):</span>
                <span class="n">new_validators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta_dict</span><span class="p">[</span><span class="s2">&quot;validate&quot;</span><span class="p">])</span>
    <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;validate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_validators</span> <span class="k">if</span> <span class="n">new_validators</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">typ_args</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">}</span>
    <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="n">typ</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">field</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s2">&quot;_marshmallow_field&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">field</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">field_for_schema</span><span class="p">(</span>
            <span class="n">newtype_supertype</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
            <span class="n">base_schema</span><span class="o">=</span><span class="n">base_schema</span><span class="p">,</span>
            <span class="n">typ_frame</span><span class="o">=</span><span class="n">typ_frame</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_generic_type_add_any</span><span class="p">(</span><span class="n">typ</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;if typ is generic type without arguments, replace them by Any.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span> <span class="n">typ</span> <span class="ow">is</span> <span class="n">List</span><span class="p">:</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">typ</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">or</span> <span class="n">typ</span> <span class="ow">is</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">typ</span> <span class="ow">is</span> <span class="n">Mapping</span><span class="p">:</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">typ</span> <span class="ow">is</span> <span class="n">Sequence</span><span class="p">:</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">typ</span> <span class="ow">is</span> <span class="nb">set</span> <span class="ow">or</span> <span class="n">typ</span> <span class="ow">is</span> <span class="n">Set</span><span class="p">:</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">Set</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">typ</span> <span class="ow">is</span> <span class="nb">frozenset</span> <span class="ow">or</span> <span class="n">typ</span> <span class="ow">is</span> <span class="n">FrozenSet</span><span class="p">:</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">typ</span>


<span class="k">def</span> <span class="nf">_field_for_generic_type</span><span class="p">(</span>
    <span class="n">typ</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
    <span class="n">base_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">]],</span>
    <span class="n">typ_frame</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">FrameType</span><span class="p">],</span>
    <span class="o">**</span><span class="n">metadata</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Field</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If the type is a generic interface, resolve the arguments and construct the appropriate Field.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">typing_inspect</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="n">typing_inspect</span><span class="o">.</span><span class="n">get_args</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">origin</span><span class="p">:</span>
        <span class="c1"># Override base_schema.TYPE_MAPPING to change the class used for generic types below</span>
        <span class="n">type_mapping</span> <span class="o">=</span> <span class="n">base_schema</span><span class="o">.</span><span class="n">TYPE_MAPPING</span> <span class="k">if</span> <span class="n">base_schema</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
            <span class="n">child_type</span> <span class="o">=</span> <span class="n">field_for_schema</span><span class="p">(</span>
                <span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base_schema</span><span class="o">=</span><span class="n">base_schema</span><span class="p">,</span> <span class="n">typ_frame</span><span class="o">=</span><span class="n">typ_frame</span>
            <span class="p">)</span>
            <span class="n">list_type</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
                <span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">List</span><span class="p">],</span>
                <span class="n">type_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="n">marshmallow</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">List</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">list_type</span><span class="p">(</span><span class="n">child_type</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="ow">and</span> <span class="n">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">Ellipsis</span>
        <span class="p">):</span>
            <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">collection_field</span>

            <span class="n">child_type</span> <span class="o">=</span> <span class="n">field_for_schema</span><span class="p">(</span>
                <span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base_schema</span><span class="o">=</span><span class="n">base_schema</span><span class="p">,</span> <span class="n">typ_frame</span><span class="o">=</span><span class="n">typ_frame</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">collection_field</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="n">cls_or_instance</span><span class="o">=</span><span class="n">child_type</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">collection_field</span>

            <span class="n">child_type</span> <span class="o">=</span> <span class="n">field_for_schema</span><span class="p">(</span>
                <span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base_schema</span><span class="o">=</span><span class="n">base_schema</span><span class="p">,</span> <span class="n">typ_frame</span><span class="o">=</span><span class="n">typ_frame</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">collection_field</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
                <span class="n">cls_or_instance</span><span class="o">=</span><span class="n">child_type</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">frozenset</span><span class="p">,</span> <span class="n">FrozenSet</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">collection_field</span>

            <span class="n">child_type</span> <span class="o">=</span> <span class="n">field_for_schema</span><span class="p">(</span>
                <span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base_schema</span><span class="o">=</span><span class="n">base_schema</span><span class="p">,</span> <span class="n">typ_frame</span><span class="o">=</span><span class="n">typ_frame</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">collection_field</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
                <span class="n">cls_or_instance</span><span class="o">=</span><span class="n">child_type</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">):</span>
            <span class="n">children</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">field_for_schema</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">base_schema</span><span class="o">=</span><span class="n">base_schema</span><span class="p">,</span> <span class="n">typ_frame</span><span class="o">=</span><span class="n">typ_frame</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arguments</span>
            <span class="p">)</span>
            <span class="n">tuple_type</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
                <span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Tuple</span><span class="p">],</span>
                <span class="n">type_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>  <span class="c1"># type:ignore[call-overload]</span>
                    <span class="n">Tuple</span><span class="p">,</span> <span class="n">marshmallow</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Tuple</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">tuple_type</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">dict_type</span> <span class="o">=</span> <span class="n">type_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Dict</span><span class="p">,</span> <span class="n">marshmallow</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Dict</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dict_type</span><span class="p">(</span>
                <span class="n">keys</span><span class="o">=</span><span class="n">field_for_schema</span><span class="p">(</span>
                    <span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base_schema</span><span class="o">=</span><span class="n">base_schema</span><span class="p">,</span> <span class="n">typ_frame</span><span class="o">=</span><span class="n">typ_frame</span>
                <span class="p">),</span>
                <span class="n">values</span><span class="o">=</span><span class="n">field_for_schema</span><span class="p">(</span>
                    <span class="n">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">base_schema</span><span class="o">=</span><span class="n">base_schema</span><span class="p">,</span> <span class="n">typ_frame</span><span class="o">=</span><span class="n">typ_frame</span>
                <span class="p">),</span>
                <span class="o">**</span><span class="n">metadata</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">typing_inspect</span><span class="o">.</span><span class="n">is_union_type</span><span class="p">(</span><span class="n">typ</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">typing_inspect</span><span class="o">.</span><span class="n">is_optional_type</span><span class="p">(</span><span class="n">typ</span><span class="p">):</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;allow_none&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allow_none&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;dump_default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dump_default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;required&quot;</span><span class="p">):</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;load_default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;load_default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;required&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">subtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">arguments</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NoneType</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subtypes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">field_for_schema</span><span class="p">(</span>
                <span class="n">subtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">base_schema</span><span class="o">=</span><span class="n">base_schema</span><span class="p">,</span>
                <span class="n">typ_frame</span><span class="o">=</span><span class="n">typ_frame</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">union_field</span>

        <span class="k">return</span> <span class="n">union_field</span><span class="o">.</span><span class="n">Union</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span>
                    <span class="n">subtyp</span><span class="p">,</span>
                    <span class="n">field_for_schema</span><span class="p">(</span>
                        <span class="n">subtyp</span><span class="p">,</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                        <span class="n">base_schema</span><span class="o">=</span><span class="n">base_schema</span><span class="p">,</span>
                        <span class="n">typ_frame</span><span class="o">=</span><span class="n">typ_frame</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">subtyp</span> <span class="ow">in</span> <span class="n">subtypes</span>
            <span class="p">],</span>
            <span class="o">**</span><span class="n">metadata</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="field_for_schema"><a class="viewcode-back" href="../marshmallow_dataclass.html#marshmallow_dataclass.field_for_schema">[docs]</a><span class="k">def</span> <span class="nf">field_for_schema</span><span class="p">(</span>
    <span class="n">typ</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">missing</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">base_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">typ_frame</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">FrameType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">marshmallow</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Field</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a marshmallow Field corresponding to the given python type.</span>
<span class="sd">    The metadata of the dataclass field is used as arguments to the marshmallow Field.</span>

<span class="sd">    :param typ: The type for which a field should be generated</span>
<span class="sd">    :param default: value to use for (de)serialization when the field is missing</span>
<span class="sd">    :param metadata: Additional parameters to pass to the marshmallow field constructor</span>
<span class="sd">    :param base_schema: marshmallow schema used as a base class when deriving dataclass schema</span>
<span class="sd">    :param typ_frame: frame of type definition</span>

<span class="sd">    &gt;&gt;&gt; int_field = field_for_schema(int, default=9, metadata=dict(required=True))</span>
<span class="sd">    &gt;&gt;&gt; int_field.__class__</span>
<span class="sd">    &lt;class &#39;marshmallow.fields.Integer&#39;&gt;</span>

<span class="sd">    &gt;&gt;&gt; int_field.dump_default</span>
<span class="sd">    9</span>

<span class="sd">    &gt;&gt;&gt; field_for_schema(str, metadata={&quot;marshmallow_field&quot;: marshmallow.fields.Url()}).__class__</span>
<span class="sd">    &lt;class &#39;marshmallow.fields.Url&#39;&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">marshmallow</span><span class="o">.</span><span class="n">missing</span><span class="p">:</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;dump_default&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="c1"># &#39;missing&#39; must not be set for required fields.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;required&quot;</span><span class="p">):</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;load_default&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;required&quot;</span><span class="p">,</span> <span class="ow">not</span> <span class="n">typing_inspect</span><span class="o">.</span><span class="n">is_optional_type</span><span class="p">(</span><span class="n">typ</span><span class="p">))</span>

    <span class="c1"># If the field was already defined by the user</span>
    <span class="n">predefined_field</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;marshmallow_field&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">predefined_field</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">predefined_field</span>

    <span class="c1"># Generic types specified without type arguments</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="n">_generic_type_add_any</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>

    <span class="c1"># Base types</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">_field_by_type</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">base_schema</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">field</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;allow_none&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">marshmallow</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Raw</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">typing_inspect</span><span class="o">.</span><span class="n">is_literal_type</span><span class="p">(</span><span class="n">typ</span><span class="p">):</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">typing_inspect</span><span class="o">.</span><span class="n">get_args</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">marshmallow</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Raw</span><span class="p">(</span>
            <span class="n">validate</span><span class="o">=</span><span class="p">(</span>
                <span class="n">marshmallow</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">else</span> <span class="n">marshmallow</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">OneOf</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="o">**</span><span class="n">metadata</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">typing_inspect</span><span class="o">.</span><span class="n">is_final_type</span><span class="p">(</span><span class="n">typ</span><span class="p">):</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">typing_inspect</span><span class="o">.</span><span class="n">get_args</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="n">subtyp</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">marshmallow</span><span class="o">.</span><span class="n">missing</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">default</span><span class="p">):</span>
                <span class="n">subtyp</span> <span class="o">=</span> <span class="n">Any</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;****** WARNING ****** &quot;</span>
                    <span class="s2">&quot;marshmallow_dataclass was called on a dataclass with an &quot;</span>
                    <span class="s1">&#39;attribute that is type-annotated with &quot;Final&quot; and uses &#39;</span>
                    <span class="s2">&quot;dataclasses.field for specifying a default value using a &quot;</span>
                    <span class="s2">&quot;factory. The Marshmallow field type cannot be inferred from the &quot;</span>
                    <span class="s2">&quot;factory and will fall back to a raw field which is equivalent to &quot;</span>
                    <span class="s1">&#39;the type annotation &quot;Any&quot; and will result in no validation. &#39;</span>
                    <span class="s2">&quot;Provide a type to Final[...] to ensure accurate validation. &quot;</span>
                    <span class="s2">&quot;****** WARNING ******&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subtyp</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;****** WARNING ****** &quot;</span>
                    <span class="s2">&quot;marshmallow_dataclass was called on a dataclass with an &quot;</span>
                    <span class="s1">&#39;attribute that is type-annotated with &quot;Final&quot; with a default &#39;</span>
                    <span class="s2">&quot;value from which the Marshmallow field type is inferred. &quot;</span>
                    <span class="s2">&quot;Support for type inference from a default value is limited and &quot;</span>
                    <span class="s2">&quot;may result in inaccurate validation. Provide a type to &quot;</span>
                    <span class="s2">&quot;Final[...] to ensure accurate validation. &quot;</span>
                    <span class="s2">&quot;****** WARNING ******&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subtyp</span> <span class="o">=</span> <span class="n">Any</span>
        <span class="k">return</span> <span class="n">field_for_schema</span><span class="p">(</span><span class="n">subtyp</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">base_schema</span><span class="p">,</span> <span class="n">typ_frame</span><span class="p">)</span>

    <span class="c1"># Generic types</span>
    <span class="n">generic_field</span> <span class="o">=</span> <span class="n">_field_for_generic_type</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">base_schema</span><span class="p">,</span> <span class="n">typ_frame</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">generic_field</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">generic_field</span>

    <span class="c1"># typing.NewType returns a function (in python &lt;= 3.9) or a class (python &gt;= 3.10) with a</span>
    <span class="c1"># __supertype__ attribute</span>
    <span class="n">newtype_supertype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s2">&quot;__supertype__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">typing_inspect</span><span class="o">.</span><span class="n">is_new_type</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="ow">and</span> <span class="n">newtype_supertype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_field_by_supertype</span><span class="p">(</span>
            <span class="n">typ</span><span class="o">=</span><span class="n">typ</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
            <span class="n">newtype_supertype</span><span class="o">=</span><span class="n">newtype_supertype</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">base_schema</span><span class="o">=</span><span class="n">base_schema</span><span class="p">,</span>
            <span class="n">typ_frame</span><span class="o">=</span><span class="n">typ_frame</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># enumerations</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">EnumMeta</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">marshmallow_enum</span>

        <span class="k">return</span> <span class="n">marshmallow_enum</span><span class="o">.</span><span class="n">EnumField</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

    <span class="c1"># Nested marshmallow dataclass</span>
    <span class="c1"># it would be just a class name instead of actual schema util the schema is not ready yet</span>
    <span class="n">nested_schema</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s2">&quot;Schema&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Nested dataclasses</span>
    <span class="n">forward_reference</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="s2">&quot;__forward_arg__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">nested</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">nested_schema</span>
        <span class="ow">or</span> <span class="n">forward_reference</span>
        <span class="ow">or</span> <span class="n">_RECURSION_GUARD</span><span class="o">.</span><span class="n">seen_classes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">_internal_class_schema</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">base_schema</span><span class="p">,</span> <span class="n">typ_frame</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">marshmallow</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Nested</span><span class="p">(</span><span class="n">nested</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_base_schema</span><span class="p">(</span>
    <span class="n">clazz</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="n">base_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base schema factory that creates a schema for `clazz` derived either from `base_schema`</span>
<span class="sd">    or `BaseSchema`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Remove `type: ignore` when mypy handles dynamic base classes</span>
    <span class="c1"># https://github.com/python/mypy/issues/2813</span>
    <span class="k">class</span> <span class="nc">BaseSchema</span><span class="p">(</span><span class="n">base_schema</span> <span class="ow">or</span> <span class="n">marshmallow</span><span class="o">.</span><span class="n">Schema</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">many</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">all_loaded</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="n">many</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">many</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">many</span> <span class="k">if</span> <span class="n">many</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">bool</span><span class="p">(</span><span class="n">many</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">many</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">clazz</span><span class="p">(</span><span class="o">**</span><span class="n">loaded</span><span class="p">)</span> <span class="k">for</span> <span class="n">loaded</span> <span class="ow">in</span> <span class="n">all_loaded</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">clazz</span><span class="p">(</span><span class="o">**</span><span class="n">all_loaded</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">BaseSchema</span>


<span class="k">def</span> <span class="nf">_get_field_default</span><span class="p">(</span><span class="n">field</span><span class="p">:</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a marshmallow default value given a dataclass default value</span>

<span class="sd">    &gt;&gt;&gt; _get_field_default(dataclasses.field())</span>
<span class="sd">    &lt;marshmallow.missing&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Remove `type: ignore` when https://github.com/python/mypy/issues/6910 is fixed</span>
    <span class="n">default_factory</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">default_factory</span>  <span class="c1"># type: ignore</span>
    <span class="k">if</span> <span class="n">default_factory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">MISSING</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default_factory</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">MISSING</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">marshmallow</span><span class="o">.</span><span class="n">missing</span>
    <span class="k">return</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span>


<div class="viewcode-block" id="NewType"><a class="viewcode-back" href="../marshmallow_dataclass.html#marshmallow_dataclass.NewType">[docs]</a><span class="k">def</span> <span class="nf">NewType</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">typ</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_U</span><span class="p">],</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">marshmallow</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Field</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">_U</span><span class="p">],</span> <span class="n">_U</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;NewType creates simple unique types</span>
<span class="sd">    to which you can attach custom marshmallow attributes.</span>
<span class="sd">    All the keyword arguments passed to this function will be transmitted</span>
<span class="sd">    to the marshmallow field constructor.</span>

<span class="sd">    &gt;&gt;&gt; import marshmallow.validate</span>
<span class="sd">    &gt;&gt;&gt; IPv4 = NewType(&#39;IPv4&#39;, str, validate=marshmallow.validate.Regexp(r&#39;^([0-9]{1,3}\\.){3}[0-9]{1,3}$&#39;))</span>
<span class="sd">    &gt;&gt;&gt; @dataclass</span>
<span class="sd">    ... class MyIps:</span>
<span class="sd">    ...   ips: List[IPv4]</span>
<span class="sd">    &gt;&gt;&gt; MyIps.Schema().load({&quot;ips&quot;: [&quot;0.0.0.0&quot;, &quot;grumble grumble&quot;]})</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    marshmallow.exceptions.ValidationError: {&#39;ips&#39;: {1: [&#39;String does not match expected pattern.&#39;]}}</span>
<span class="sd">    &gt;&gt;&gt; MyIps.Schema().load({&quot;ips&quot;: [&quot;127.0.0.1&quot;]})</span>
<span class="sd">    MyIps(ips=[&#39;127.0.0.1&#39;])</span>

<span class="sd">    &gt;&gt;&gt; Email = NewType(&#39;Email&#39;, str, field=marshmallow.fields.Email)</span>
<span class="sd">    &gt;&gt;&gt; @dataclass</span>
<span class="sd">    ... class ContactInfo:</span>
<span class="sd">    ...   mail: Email = dataclasses.field(default=&quot;anonymous@example.org&quot;)</span>
<span class="sd">    &gt;&gt;&gt; ContactInfo.Schema().load({})</span>
<span class="sd">    ContactInfo(mail=&#39;anonymous@example.org&#39;)</span>
<span class="sd">    &gt;&gt;&gt; ContactInfo.Schema().load({&quot;mail&quot;: &quot;grumble grumble&quot;})</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    marshmallow.exceptions.ValidationError: {&#39;mail&#39;: [&#39;Not a valid email address.&#39;]}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># noinspection PyTypeHints</span>
    <span class="n">new_type</span> <span class="o">=</span> <span class="n">typing_NewType</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
    <span class="c1"># noinspection PyTypeHints</span>
    <span class="n">new_type</span><span class="o">.</span><span class="n">_marshmallow_field</span> <span class="o">=</span> <span class="n">field</span>  <span class="c1"># type: ignore</span>
    <span class="c1"># noinspection PyTypeHints</span>
    <span class="n">new_type</span><span class="o">.</span><span class="n">_marshmallow_args</span> <span class="o">=</span> <span class="n">kwargs</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">new_type</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>

    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">marshmallow_dataclass</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">marshmallow_dataclass</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Ophir LOJKINE.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 6.0.0b2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>